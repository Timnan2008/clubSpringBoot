<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{page.title.clubTemplate}">社团介绍</title>
    <link rel="stylesheet" href="/css/club-template_style.css">
</head>

<body>
<div id="particles"></div>
<div th:replace="fragments/notice :: notice"></div>
<div th:replace="fragments/notice-repeat :: notice"></div>
<div th:replace="fragments/navbar :: navbar"></div>
<div th:replace="fragments/particle :: particle"></div>

<script th:inline="javascript">
    const clubName = /*[[${club}]]*/ 'default';

    console.log("DEBUG 当前社团名:", clubName);

    const apiUrl = `/api/club/name-en/${encodeURIComponent(clubName)}`;
    console.log("DEBUG 发起请求到:", apiUrl);

    fetch(apiUrl)
        .then(res => res.json())
        .then(result => {
            console.log("DEBUG 返回结果:", result);
            const club = result.data;
            console.log("DEBUG 获取的社团信息:", club);

            if (!club) {
                document.getElementById("club-title").textContent = "未找到该社团";
                return;
            }

            // ✅ 这里每个元素都存在
            console.log("DEBUG club-name:", club.clubName);
            document.getElementById("club-title").textContent = club.clubName;
            console.log("DEBUG president:", club.president);
            document.getElementById("president").textContent = club.president || "暂无";
            console.log("DEBUG vicePresident:", club.vicePresident);
            document.getElementById("vicePresident").textContent = club.vicePresident || "暂无";
            console.log("DEBUG teacher:", club.teacher);
            document.getElementById("teacher").textContent = club.teacher || "暂无";
            console.log("DEBUG club-intro:", club.clubDescription);
            document.getElementById("club-intro").textContent = club.clubDescription || "暂无介绍";
            document.getElementById("club-intro").style.display = 'block';

            console.log("DEBUG club-logo:", club.clubItem);
            document.getElementById("club-logo").src = club.clubItem;

            console.log("DEBUG club-video:", club.video);
            if (club.video) {
                document.getElementById("club-video").src = club.video;
            }

            console.log("DEBUG like-count:", club.videoLike);
            document.getElementById("currentnumber").textContent = club.videoLike || "0";
            document.getElementById("movenumber").textContent = club.videoLike + 1 || "1";
        });
</script>

<!-- 主体内容 -->
<div class="container">
    <h1><span id="club-title" th:text="#{clubDetail.clubName}">社团名称</span></h1>
    <div class="top-info">
        <div class="leaders">
            <p><strong th:text="#{clubDetail.clubPresident} + '：'">社长：</strong><span id="president">加载中</span></p>
            <p><strong th:text="#{clubDetail.vicePresident} + '：'">副社长：</strong><span id="vicePresident">加载中</span></p>
            <p><strong th:text="#{clubDetail.teacher} + '：'">指导老师：</strong><span id="teacher">加载中</span></p>
        </div>
        <img id="club-logo" class="club-logo">
    </div>

    <div class="intro">
        <h2 th:text="#{clubDetail.clubDescription}">社团简介</h2>
        <p id="club-intro">加载中...</p>
    </div>

    <h1 th:text="#{clubDetail.clubActivities}">社团视频展示</h1>

    <div class="video-container">
        <video id="club-video" width="100%" controls>
            <source type="video/mp4">
            <span th:text="#{common.browserNotSupport}">您的浏览器不支持 video 标签。</span>
        </video>

        <div class="button-container">
            <input hidden="" id="checknumber" type="checkbox" />
            <label for="checknumber" class="button">
                <div id="leftpart">
                    <p id="currentnumber">24</p>
                    <p id="movenumber">25</p>
                </div>

                <div id="rightpart">
                    <svg
                            id="likeimg"
                            stroke-linejoin="round"
                            stroke-linecap="round"
                            stroke-width="3"
                            stroke="#00d5ff"
                            fill="none"
                            viewBox="0 0 24 24"
                            height="24"
                            width="24"
                            xmlns="http://www.w3.org/2000/svg"
                    >
                        <path
                                d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"
                        ></path>
                    </svg>
                    <div id="fontlikebutton">Like</div>
                </div>
            </label>
        </div>
    </div>
</div>

<a href="https://beian.miit.gov.cn" style="position: absolute; width: 100%; text-align: center; color: #9096b0;">沪ICP备2025137067号</a>

<!-- 点赞功能 -->
<script th:inline="javascript">
    let deviceId;

    window.addEventListener("DOMContentLoaded", () => {
        function generateUUID() {
            if (crypto.randomUUID) return crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        if(localStorage.getItem('deviceId') === "undefined"){
            deviceId = generateUUID();
            console.log("DEBUG 生成的deviceId:", deviceId);
        }else{
            deviceId = localStorage.getItem('deviceId') || generateUUID();
            console.log("DEBUG 获取的deviceId:", deviceId);
        }

        localStorage.setItem('deviceId', deviceId);

        likeToggle.addEventListener("change", () =>{
            if (likeToggle.checked) {
                console.log("点赞按钮被点击");
                performLike();
            } else {
                console.log("取消点赞");
                performUnlike();
            }
        });
    });

    const clubName2 = /*[[${club}]]*/ 'default';
    console.log("DEBUG 当前社团名2:", clubName2);

    const likeToggle = document.getElementById("checknumber");
    const likeCountEl = document.getElementById("currentnumber");
    const likeCountElAfter = document.getElementById("movenumber");

    window.addEventListener("DOMContentLoaded", () => {
        const key = `liked_${clubName2}`;
        if (localStorage.getItem(key) === "true") {
            likeToggle.checked = true;
        }
    });

    const url = `/api/club/name-en/${encodeURIComponent(clubName2)}`;
    console.log("DEBUG 获取点赞数请求地址:", url);

    // 页面加载时初始化点赞数
    fetch(url, { method: "GET"})
        .then(res => res.json())
        .then(result => {
            console.log("debug点赞时：" + result);
            if (result.data){
                likeCountEl.textContent = result.data.videoLike ;
                likeCountElAfter.textContent = result.data.videoLike + 1;
            }
        });

    function performLike(){
        console.log("正在点赞");
        console.log("DEBUG 设备ID:", deviceId);
        fetch(`/api/club/like/${encodeURIComponent(clubName2)}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Device-Id": deviceId
            }})
            .then(res => res.json())
            .then(result => {
                if (result.code === 200) {
                    fetch(`/api/club/name-en/${encodeURIComponent(clubName2)}`)
                        .then(res => res.json())
                        .then(result => {
                            console.log("点赞数" + result.data.videoLike);
                        });
                    likeToggle.checked = true;
                } else {
                    showNotice("点赞失败：" + (result.message || "未知错误"));
                    likeToggle.checked = false;
                }
            })
            .catch(err => {
                showNotice("点赞失败：" + "你不可以刷赞");
                likeToggle.checked = false;
            });
    }

    function performUnlike(){
        console.log("DEBUG 设备ID:", deviceId);
        console.log("正在取消点赞");
        fetch(`/api/club/dislike/${encodeURIComponent(clubName2)}`, {
            method: "PUT" ,
            headers: {
                "Content-Type": "application/json",
                "X-Device-Id": deviceId
            }
        })
            .then(res => res.json())
            .then(result => {
                if (result.code === 200) {
                    fetch(`/api/club/name-en/${encodeURIComponent(clubName2)}`)
                        .then(res => res.json())
                        .then(result => {
                            console.log("点赞数" + result.data.videoLike);
                        });
                    likeToggle.checked = false;
                } else {
                    alert("取消点赞失败：" + (result.message || "未知错误"));
                    likeToggle.checked = true;
                }
            })
            .catch(err => {
                console.error("取消点赞失败：", err);
                likeToggle.checked = true;
            });
    }
</script>

</body>
</html>