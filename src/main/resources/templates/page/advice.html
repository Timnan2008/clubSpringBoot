<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ„è§ç®±ï¼ˆå«é˜²åˆ·ï¼‰</title>
  <style>
    /* å…¨å±€æ ·å¼é‡ç½® */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* æœªæ¥æ„ŸèƒŒæ™¯ */
    body {
      font-family: 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2a2f4a 100%);
      color: #e0e0ff;
      min-height: 100vh;
      padding: 24px;
      position: relative;
      overflow-x: hidden;
    }

    /* åŠ¨æ€ç½‘æ ¼èƒŒæ™¯ - å¢å¼ºæ•ˆæœ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(100, 150, 255, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(100, 150, 255, 0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: gridMove 20s linear infinite, gridPulse 3s ease-in-out infinite alternate;
      z-index: -3;
    }

    /* å¢å¼ºçš„éœ“è™¹å…‰æ•ˆ */
    body::after {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(100, 150, 255, 0.03) 0%, transparent 70%),
                  radial-gradient(circle, rgba(150, 100, 255, 0.02) 0%, transparent 70%);
      background-position: 0% 0%, 50% 50%;
      background-size: 100% 100%, 80% 80%;
      animation: pulse 4s ease-in-out infinite, backgroundShift 8s ease-in-out infinite;
      z-index: -2;
    }

    /* åŠ¨æ€ç²’å­èƒŒæ™¯ */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }

    /* å¢å¼ºçš„ç²’å­æ•ˆæœ */
    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(140, 160, 255, 0.4);
      border-radius: 50%;
      box-shadow: 0 0 3px rgba(140, 160, 255, 0.6);
      animation: particleFloat 6s linear infinite;
    }

    @keyframes particleFloat {
      0% {
        transform: translateY(100vh) translateX(0) scale(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
        transform: translateY(90vh) translateX(10px) scale(1);
      }
      50% {
        transform: translateY(50vh) translateX(-15px) scale(1.2);
      }
      90% {
        opacity: 1;
        transform: translateY(10vh) translateX(10px) scale(1);
      }
      100% {
        transform: translateY(0) translateX(0) scale(0);
        opacity: 0;
      }
    }

    /* ç½‘æ ¼è„‰å†²æ•ˆæœ */
    @keyframes gridPulse {
      0% {
        background-image: 
          linear-gradient(rgba(100, 150, 255, 0.08) 1px, transparent 1px),
          linear-gradient(90deg, rgba(100, 150, 255, 0.08) 1px, transparent 1px);
      }
      100% {
        background-image: 
          linear-gradient(rgba(100, 150, 255, 0.15) 1px, transparent 1px),
          linear-gradient(90deg, rgba(100, 150, 255, 0.15) 1px, transparent 1px);
      }
    }

    /* èƒŒæ™¯ç§»åŠ¨æ•ˆæœ */
    @keyframes backgroundShift {
      0% {
        background-position: 0% 0%, 50% 50%;
      }
      50% {
        background-position: 100% 100%, 0% 0%;
      }
      100% {
        background-position: 50% 50%, 100% 100%;
      }
    }

    /* å®¹å™¨ */
    .container {
      max-width: 900px;
      margin: 0 auto;
      z-index: 1;
      position: relative;
    }

    /* æ ‡é¢˜ */
    h1 {
      font-size: 32px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 32px;
      background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      letter-spacing: 2px;
    }

    /* å¡ç‰‡åŸºç¡€æ ·å¼ - ç»ç’ƒæ€æ•ˆæœ */
    .card {
      background: rgba(26, 31, 58, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(100, 200, 255, 0.2);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      padding: 24px;
      margin-bottom: 24px;
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 
        0 12px 40px rgba(0, 255, 255, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
      border-color: rgba(0, 255, 255, 0.4);
    }

    /* è¡¨å•å…ƒç´ æ ·å¼ - ç®€åŒ–è®¾è®¡ */
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #d0d0ff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid rgba(150, 180, 255, 0.2);
      background: rgba(15, 20, 45, 0.8);
      color: #ffffff;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: rgba(150, 180, 255, 0.5);
      box-shadow: 0 0 0 2px rgba(150, 180, 255, 0.1);
      background: rgba(20, 25, 50, 0.9);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
      max-height: 300px;
    }

    /* æŒ‰é’®æ ·å¼ */
    button {
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    /* ä¸»æŒ‰é’®æ ·å¼ - ç®€åŒ–è®¾è®¡ */
    .btn-primary {
      background: linear-gradient(135deg, rgba(100, 150, 255, 0.8) 0%, rgba(150, 100, 255, 0.8) 100%);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(100, 150, 255, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(100, 150, 255, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    /* æ¬¡è¦æŒ‰é’®æ ·å¼ - ç®€åŒ–è®¾è®¡ */
    .btn-ghost {
      background: rgba(100, 150, 255, 0.1);
      color: #c0c0ff;
      border: 1px solid rgba(150, 180, 255, 0.3);
    }

    .btn-ghost:hover {
      background: rgba(100, 150, 255, 0.2);
      border-color: rgba(150, 180, 255, 0.5);
      box-shadow: 0 0 12px rgba(100, 150, 255, 0.15);
    }

    /* å¤é€‰æ¡†æ ·å¼ */
    input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
      accent-color: #00ffff;
    }

    /* ç½‘æ ¼å¸ƒå±€ */
    .flex {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .flex > div {
      flex: 1;
    }

    /* é˜²åˆ·éªŒè¯åŒºåŸŸ */
    #captcha-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
      flex-wrap: wrap;
    }

    #captcha {
      width: 220px;
      height: 80px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 255, 255, 0.3);
      background: rgba(10, 14, 39, 0.8);
    }

    #captcha:hover {
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      border-color: #00ffff;
    }

    /* é˜²åˆ·æç¤º */
    #anti-spam-tip {
      margin-top: 12px;
      color: #ff6b6b;
      font-size: 14px;
      display: none;
      padding: 12px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    /* ç¦ç”¨æŒ‰é’®æ ·å¼ */
    #submit-btn:disabled {
      background: rgba(100, 100, 100, 0.3);
      color: rgba(200, 200, 200, 0.5);
      box-shadow: none;
      cursor: not-allowed;
    }

    /* å†å²è®°å½•æ ‡é¢˜ */
    h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #00ffff;
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
    }

    h3::before {
      content: "ğŸ“¡";
      margin-right: 12px;
      font-size: 28px;
    }

    /* å»ºè®®é¡¹æ ·å¼ */
    .suggestion-item {
      background: rgba(26, 31, 58, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid rgba(100, 200, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .suggestion-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #00ffff 0%, #ff00ff 100%);
    }

    .suggestion-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 255, 255, 0.1);
      border-color: rgba(0, 255, 255, 0.4);
    }

    /* å»ºè®®å¤´éƒ¨ */
    .suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* å»ºè®®æ ‡é¢˜ */
    .suggestion-title {
      font-weight: 600;
      font-size: 14px;
      padding: 6px 16px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .suggestion-title.general {
      background: rgba(0, 255, 255, 0.2);
      color: #00ffff;
    }

    .suggestion-title.bug {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }

    .suggestion-title.feature {
      background: rgba(72, 187, 120, 0.2);
      color: #48bb78;
    }

    /* å»ºè®®å…ƒä¿¡æ¯ */
    .suggestion-meta {
      font-size: 12px;
      color: #b0b0ff;
      background: rgba(176, 176, 255, 0.1);
      padding: 4px 12px;
      border-radius: 12px;
    }

    /* å»ºè®®å†…å®¹ */
    .suggestion-content {
      color: #e0e0ff;
      line-height: 1.6;
      font-size: 14px;
      padding-left: 12px;
    }

    /* ç©ºçŠ¶æ€ */
    .empty {
      padding: 40px 20px;
      text-align: center;
      color: #b0b0ff;
      font-size: 16px;
      background: rgba(26, 31, 58, 0.4);
      border-radius: 12px;
      border: 2px dashed rgba(0, 255, 255, 0.2);
    }

    .empty::before {
      content: "ğŸŒŒ";
      font-size: 32px;
      display: block;
      margin-bottom: 12px;
    }

    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes gridMove {
      0% {
        background-position: 0 0;
      }
      100% {
        background-position: 50px 50px;
      }
    }

    /* ç½‘æ ¼æ—‹è½¬æ•ˆæœ */
    @keyframes gridRotate {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.3;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.5;
      }
    }

    /* èƒŒæ™¯æµ®åŠ¨æ•ˆæœ */
    @keyframes backgroundFloat {
      0%, 100% {
        transform: translate(-50%, -50%) scale(1);
      }
      33% {
        transform: translate(-55%, -45%) scale(1.05);
      }
      66% {
        transform: translate(-45%, -55%) scale(0.95);
      }
    }

    /* èƒŒæ™¯ç¼©æ”¾æ•ˆæœ */
    @keyframes backgroundScale {
      0% {
        transform: scale(1);
      }
      100% {
        transform: scale(1.1);
      }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media(max-width: 768px) {
      body {
        padding: 16px;
      }

      h1 {
        font-size: 24px;
      }

      .card {
        padding: 20px;
      }

      .flex {
        flex-direction: column;
      }

      #captcha-container {
        flex-direction: column;
        align-items: stretch;
      }

      #captcha {
        width: 100%;
      }
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      position: relative;
      overflow: hidden;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      100% {
        left: 100%;
      }
    }

    /* å­—ç¬¦è®¡æ•° */
    #charCount {
      text-align: right;
      font-size: 12px;
      color: #b0b0ff;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- åŠ¨æ€ç²’å­èƒŒæ™¯ -->
  <div class="particles" id="particles"></div>
  
  <div class="container">
    <h1 style="color: #e0e0ff; text-shadow: 0 0 10px rgba(150, 180, 255, 0.3);">âœ¨ æ„è§ç®± âœ¨</h1>
    
    <div class="card">
      <form id="form">
        <div class="flex">
          <div>
            <label for="name">å§“å</label>
            <input id="name" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" />
          </div>
          <div>
            <label for="number">å­¦å·</label>
            <input id="number" type="number" placeholder="è¯·è¾“å…¥æ‚¨çš„å­¦å·" />
          </div>
        </div>

        <label for="category" style="margin-top: 16px;">åˆ†ç±»</label>
        <select id="category">
          <option value="general">ä¸€èˆ¬å»ºè®®</option>
          <option value="bug">é”™è¯¯ / Bug</option>
          <option value="feature">åŠŸèƒ½è¯·æ±‚</option>
        </select>

        <label for="message" style="margin-top: 16px;">å†…å®¹</label>
        <textarea id="message" maxlength="500" placeholder="è¯·è¾“å…¥æ‚¨çš„å»ºè®®æˆ–åé¦ˆ..."></textarea>
        <div id="charCount">0/500</div>

        <label style="margin-top: 16px;">
          <input id="anon" type="checkbox" /> åŒ¿åæäº¤
        </label>

        <!-- é˜²åˆ·éªŒè¯åŒºåŸŸ -->
        <div style="margin-top: 24px; padding: 20px; border-radius: 16px; background: rgba(10, 14, 39, 0.8); border: 1px solid rgba(255, 0, 255, 0.3);">
          <strong style="color: #00ffff; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 16px;">ğŸ”’ é˜²åˆ·éªŒè¯</strong>
          
          <!-- CSRFä»¤ç‰Œ -->
          <input type="hidden" id="csrfToken" value="${csrfToken}">
          
          <!-- Honeypotå­—æ®µ -->
          <input type="text" id="honeypot" style="display: none;" placeholder="è¯·ä¸è¦å¡«å†™æ­¤å­—æ®µ">
          
          <!-- å¢å¼ºå‹éªŒè¯ç  -->
          <div id="captcha-container">
            <canvas id="captcha" width="220" height="80"></canvas>
            <button type="button" id="refresh-captcha" class="btn-ghost">åˆ·æ–°</button>
          </div>
          
          <input id="captchaAns" type="text" placeholder="è¯·è¾“å…¥éªŒè¯ç " style="margin-top: 12px; margin-bottom: 12px;" />
          <div id="anti-spam-tip"></div>
        </div>

        <button class="btn-primary" type="submit" id="submit-btn" style="margin-top: 20px; width: 100%;">æäº¤</button>
      </form>
    </div>

    <div class="card">
      <h3>å†å²è®°å½•</h3>
      <div id="list"></div>
    </div>
  </div>

<script>
// æ„è§åé¦ˆè¡¨å•æäº¤å¤„ç†

// APIåŸºç¡€URL
const API_BASE_URL = '/api/suggestion';

// -------- é˜²åˆ·æœºåˆ¶ï¼šå¢å¼ºå‹éªŒè¯ç  --------
let captchaText = '';
let lastSubmitTime = 0;
let submitAttempts = 0;
const MIN_SUBMIT_INTERVAL = 60000; // 60ç§’æäº¤é—´éš”
const MAX_ATTEMPTS = 3; // æœ€å¤§å°è¯•æ¬¡æ•°

// ç”Ÿæˆå¤æ‚å›¾å½¢éªŒè¯ç 
  function generateCaptcha() {
    const canvas = document.getElementById('captcha');
    const ctx = canvas.getContext('2d');
    
    // ä½¿ç”¨å­—æ¯å’Œæ•°å­—ï¼Œæ’é™¤å®¹æ˜“æ··æ·†çš„å­—ç¬¦
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    captchaText = '';
    
    // æ¸…ç©ºç”»å¸ƒ
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ç”Ÿæˆæ·±è‰²èƒŒæ™¯
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    gradient.addColorStop(0, 'rgba(10, 14, 39, 0.9)');
    gradient.addColorStop(0.5, 'rgba(26, 31, 58, 0.9)');
    gradient.addColorStop(1, 'rgba(10, 14, 39, 0.9)');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // æ·»åŠ é€‚é‡å™ªç‚¹
    for (let i = 0; i < 300; i++) {
      ctx.fillStyle = Math.random() > 0.5 ? 'rgba(0, 255, 255, 0.2)' : 'rgba(255, 0, 255, 0.2)';
      ctx.beginPath();
      ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 2, 0, Math.PI * 2);
      ctx.fill();
    }
    
    // æ·»åŠ ç½‘æ ¼çº¿
    ctx.strokeStyle = 'rgba(0, 255, 255, 0.1)';
    ctx.lineWidth = 0.3;
    for (let i = 0; i < canvas.width; i += 15) {
      ctx.beginPath();
      ctx.moveTo(i, 0);
      ctx.lineTo(i, canvas.height);
      ctx.stroke();
    }
    for (let i = 0; i < canvas.height; i += 15) {
      ctx.beginPath();
      ctx.moveTo(0, i);
      ctx.lineTo(canvas.width, i);
      ctx.stroke();
    }
    
    // ç”Ÿæˆå¹¶ç»˜åˆ¶å­—ç¬¦
    const fontSize = 28 + Math.random() * 8;
    const fontFamilies = ['Arial Black', 'Impact', 'Verdana', 'Courier New'];
    
    for (let i = 0; i < 6; i++) {
      const char = chars.charAt(Math.floor(Math.random() * chars.length));
      captchaText += char;
      
      // æé«˜å­—ç¬¦äº®åº¦å’Œå¯¹æ¯”åº¦
      const colors = ['rgba(0, 255, 255, 0.9)', 'rgba(255, 0, 255, 0.9)', 'rgba(255, 255, 0, 0.9)', 'rgba(0, 255, 0, 0.9)'];
      ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
      ctx.font = fontSize + 'px ' + fontFamilies[Math.floor(Math.random() * fontFamilies.length)];
      ctx.textBaseline = 'middle';
      
      // å¢å¼ºå‘å…‰æ•ˆæœ
      ctx.shadowColor = ctx.fillStyle;
      ctx.shadowBlur = 5;
      
      // å­—ç¬¦æ—‹è½¬ã€ç¼©æ”¾ã€ä½ç§» - ä¼˜åŒ–ä½ç½®é¿å…é‡å 
      const x = 35 + i * 30 + Math.random() * 8 - 4;
      const y = canvas.height / 2 + Math.random() * 15 - 7.5;
      const rotation = (Math.random() - 0.5) * 0.4;
      const scale = 0.8 + Math.random() * 0.2;
      
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rotation);
      ctx.scale(scale, scale);
      
      // ç»˜åˆ¶å­—ç¬¦
      ctx.fillText(char, 0, 0);
      ctx.restore();
    }
    
    // æ·»åŠ é€‚é‡å¹²æ‰°çº¿
    for (let i = 0; i < 5; i++) {
      ctx.strokeStyle = Math.random() > 0.5 ? 'rgba(0, 255, 255, 0.5)' : 'rgba(255, 0, 255, 0.5)';
      ctx.lineWidth = Math.random() * 1.5 + 0.5;
      ctx.beginPath();
      ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
      ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
      ctx.stroke();
    }
    
    // æ·»åŠ é€‚é‡æ³¢æµªå¹²æ‰°çº¿
    for (let i = 0; i < 2; i++) {
      ctx.strokeStyle = Math.random() > 0.5 ? 'rgba(0, 255, 255, 0.3)' : 'rgba(255, 0, 255, 0.3)';
      ctx.lineWidth = Math.random() * 1.5 + 0.5;
      ctx.beginPath();
      for (let x = 0; x < canvas.width; x++) {
        const y = Math.sin(x / 15 + Math.random() * 3) * (10 + Math.random() * 10) + canvas.height / 2;
        if (x === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();
    }
    
    // å‡å°‘é®ç½©å±‚é€æ˜åº¦
    ctx.fillStyle = 'rgba(10, 14, 39, 0.1)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // é‡ç½®é˜´å½±
    ctx.shadowBlur = 0;
  }

generateCaptcha();

// åˆ·æ–°éªŒè¯ç 
document.getElementById('refresh-captcha').addEventListener('click', generateCaptcha);

// ç‚¹å‡»éªŒè¯ç ä¹Ÿå¯åˆ·æ–°
document.getElementById('captcha').addEventListener('click', generateCaptcha);

// åˆ›å»ºåŠ¨æ€ç²’å­
createParticles();

// å­—ç¬¦è®¡æ•°åŠŸèƒ½
document.getElementById('message').addEventListener('input', function() {
  const message = this.value;
  const count = message.length;
  const charCount = document.getElementById('charCount');
  charCount.textContent = count + '/500';
  
  if (count > 450) {
    charCount.style.color = '#ff6b6b';
  } else {
    charCount.style.color = '#b0b0ff';
  }
});

// åˆ›å»ºæ›´å¤šåŠ¨æ€ç²’å­
function createParticles() {
  const particlesContainer = document.getElementById('particles');
  const particleCount = 100;
  
  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.animationDelay = Math.random() * 6 + 's';
    particle.style.animationDuration = (4 + Math.random() * 6) + 's';
    // éšæœºå¤§å°
    const size = Math.random() * 3 + 1;
    particle.style.width = size + 'px';
    particle.style.height = size + 'px';
    // éšæœºé¢œè‰²
    const colors = [
      'rgba(140, 160, 255, 0.4)',
      'rgba(160, 140, 255, 0.4)',
      'rgba(120, 180, 255, 0.4)'
    ];
    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
    particle.style.boxShadow = '0 0 3px ' + colors[Math.floor(Math.random() * colors.length)];
    particlesContainer.appendChild(particle);
  }
}

// -------- è¡¨å•æäº¤ --------
document.getElementById('form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submit-btn');
  const antiSpamTip = document.getElementById('anti-spam-tip');
  
  // 1) æ£€æŸ¥èœœç½å­—æ®µï¼ˆé˜²æ­¢è‡ªåŠ¨æœºå™¨äººï¼‰
  const honeypot = document.getElementById('honeypot').value;
  if (honeypot.trim() !== '') {
    alert('é˜²åˆ·éªŒè¯å¤±è´¥');
    return;
  }
  
  // 2) æ£€æŸ¥æäº¤é—´éš”
  const now = Date.now();
  if (now - lastSubmitTime < MIN_SUBMIT_INTERVAL) {
    const remainingTime = Math.ceil((MIN_SUBMIT_INTERVAL - (now - lastSubmitTime)) / 1000);
    antiSpamTip.textContent = `æäº¤è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… ${remainingTime} ç§’åå†è¯•ã€‚`;
    antiSpamTip.style.display = 'block';
    return;
  }
  
  // 3) æ£€æŸ¥å°è¯•æ¬¡æ•°
  if (submitAttempts >= MAX_ATTEMPTS) {
    antiSpamTip.textContent = `å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯· ${Math.ceil(MIN_SUBMIT_INTERVAL / 1000)} ç§’åå†è¯•ã€‚`;
    antiSpamTip.style.display = 'block';
    submitBtn.disabled = true;
    setTimeout(() => {
      submitBtn.disabled = false;
      submitAttempts = 0;
      antiSpamTip.style.display = 'none';
    }, MIN_SUBMIT_INTERVAL);
    return;
  }
  
  // 4) éªŒè¯ç éªŒè¯
  const inputVal = document.getElementById('captchaAns').value.trim().toUpperCase();
  if (inputVal !== captchaText) {
    antiSpamTip.textContent = 'éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚';
    antiSpamTip.style.display = 'block';
    generateCaptcha();
    submitAttempts++;
    return;
  }
  
  // 5) å†…å®¹éªŒè¯
  const msg = document.getElementById('message').value.trim();
  if (msg.length < 5) {
    alert('è¯·è‡³å°‘è¾“å…¥ 5 ä¸ªå­—ã€‚');
    return;
  }
  
  // 6) å‡†å¤‡æäº¤æ•°æ®
  const name = document.getElementById('name').value.trim();
  const category = document.getElementById('category').value;
  const anon = document.getElementById('anon').checked;
  
  const suggestionData = {
    title: category, // ä½¿ç”¨åˆ†ç±»ä½œä¸ºæ ‡é¢˜
    context: msg,
    isAnonymous: anon,
    name: anon ? '' : name
  };

  console.log(suggestionData);
  
  // 7) ç¦ç”¨æäº¤æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
  submitBtn.disabled = true;
  submitBtn.textContent = 'æäº¤ä¸­...';
  submitBtn.classList.add('loading');
  antiSpamTip.style.display = 'none';
  
  try {
    // 8) å‘é€POSTè¯·æ±‚åˆ°åç«¯
    const response = await fetch(`${API_BASE_URL}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(suggestionData)
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.message || 'æäº¤å¤±è´¥');
    }
    
    alert('æäº¤æˆåŠŸï¼');
    document.getElementById('form').reset();
    document.getElementById('charCount').textContent = '0/500';
    generateCaptcha();
    // é‡ç½®é˜²åˆ·æœºåˆ¶
    lastSubmitTime = now;
    submitAttempts = 0;
    // åˆ·æ–°å†å²è®°å½•
    fetchSuggestions();
  } catch (error) {
    console.error('æäº¤å¤±è´¥:', error);
    alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    submitAttempts++;
  } finally {
    // æ¢å¤æäº¤æŒ‰é’®çŠ¶æ€
    submitBtn.disabled = false;
    submitBtn.textContent = 'æäº¤';
    submitBtn.classList.remove('loading');
  }
});

// -------- è·å–å†å²è®°å½• --------
async function fetchSuggestions() {
  const listContainer = document.getElementById('list');
  listContainer.innerHTML = '<div class="empty">åŠ è½½ä¸­...</div>';
  
  try {
    const response = await fetch(`${API_BASE_URL}/all`);
    if (!response.ok) {
      throw new Error('è·å–å†å²è®°å½•å¤±è´¥');
    }
    const result = await response.json();
    if (result.code === 200 && result.data) {
      renderSuggestions(result.data);
    } else {
      renderEmpty();
    }
  } catch (error) {
    console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
    renderEmpty();
  }
}

// -------- æ¸²æŸ“å†å²è®°å½• --------
function renderSuggestions(suggestions) {
  const listContainer = document.getElementById('list');
  listContainer.innerHTML = '';
  
  if (!suggestions || suggestions.length === 0) {
    renderEmpty();
    return;
  }
  
  // æŒ‰IDé™åºæ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
  suggestions.sort((a, b) => b.id - a.id);
  
  suggestions.forEach(suggestion => {
    const suggestionItem = document.createElement('div');
    suggestionItem.className = 'suggestion-item';
    
    // æ ‡é¢˜å’ŒåŒ¿åä¿¡æ¯
    const header = document.createElement('div');
    header.className = 'suggestion-header';
    
    const title = document.createElement('span');
    title.className = `suggestion-title ${suggestion.title}`;
    title.textContent = getTitleText(suggestion.title);
    
    const meta = document.createElement('span');
    meta.className = 'suggestion-meta';
    meta.textContent = suggestion.isAnonymous ? 'åŒ¿å' : (suggestion.name || 'æœªçŸ¥');
    
    header.appendChild(title);
    header.appendChild(meta);
    
    // å†…å®¹
    const content = document.createElement('div');
    content.className = 'suggestion-content';
    content.textContent = suggestion.context;
    
    suggestionItem.appendChild(header);
    suggestionItem.appendChild(content);
    listContainer.appendChild(suggestionItem);
  });
}

// -------- æ¸²æŸ“ç©ºçŠ¶æ€ --------
function renderEmpty() {
  const listContainer = document.getElementById('list');
  listContainer.innerHTML = '<div class="empty">æš‚æ— å†å²è®°å½•</div>';
}

// -------- è·å–æ ‡é¢˜æ–‡æœ¬ --------
function getTitleText(title) {
  const titleMap = {
    'general': 'âš”ï¸ ä¸€èˆ¬å»ºè®®',
    'bug': 'ğŸ› BUGä¸¾æŠ¥',
    'feature': 'ğŸŒŸ æ–°å†…å®¹è¯·æ±‚'
  };
  return titleMap[title] || title;
}

// -------- é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½• --------
document.addEventListener('DOMContentLoaded', fetchSuggestions);
</script>
</body>
</html>