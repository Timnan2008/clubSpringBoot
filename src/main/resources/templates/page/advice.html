<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ˜äº®ç‰ˆæ„è§ç®±ï¼ˆå«é˜²åˆ·ï¼‰</title>
  <style>
    body { font-family: system-ui; background:#f5f7fa; margin:0; padding:24px; color:#1f2937; }
    .container { max-width:900px; margin:0 auto; }
    h1 { margin:0; font-size:24px; }
    .card { background:#ffffff; padding:18px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-top:16px; }
    label { display:block; margin-bottom:6px; font-size:14px; }
    input, textarea, select { width:100%; padding:10px; font-size:14px; border-radius:8px; border:1px solid #d1d5db; }
    textarea { resize:vertical; min-height:100px; }
    button { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-size:16px; }
    .btn-primary { background:#0ea5e9; color:white; }
    .btn-ghost { background:#e5e7eb; color:#374151; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { padding:8px; border-bottom:1px solid #e5e7eb; font-size:14px; }
    .empty { padding:16px; text-align:center; color:#6b7280; }
    .flex { display:flex; gap:12px; }
    @media(max-width:640px){ .flex{ flex-direction:column; } }
    /* é˜²åˆ·éªŒè¯ */
    #captchaQ { margin:12px 0; color:#880e4f; font-size:16px; }
    
    h3 { margin-top:0; color:#ad1457; font-size:20px; display:flex; align-items:center; }
    h3::before { content:"ğŸ’–"; margin-right:8px; }
    
    /* å»ºè®®é¡¹æ ·å¼ */
    .suggestion-item { background: linear-gradient(135deg, #ffffff 0%, #ffebee 100%); border:2px solid #f8bbd0; border-radius:16px; padding:16px; margin-bottom:16px; box-shadow:0 4px 12px rgba(233, 30, 99, 0.08); transition: all 0.3s ease; }
    .suggestion-item:hover { transform: translateY(-2px); box-shadow:0 6px 16px rgba(233, 30, 99, 0.12); border-color:#e91e63; }
    
    /* å»ºè®®å¤´éƒ¨ */
    .suggestion-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:8px; }
    
    /* å»ºè®®æ ‡é¢˜ */
    .suggestion-title { font-weight:600; font-size:14px; padding:6px 12px; border-radius:20px; color:rgb(0, 0, 0); }
    .suggestion-title.general { background: linear-gradient(135deg, #ffb3e5 0%, #ff85c0 100%); }
    .suggestion-title.bug { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color:#880e4f; }
    .suggestion-title.feature { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); color:#1a237e; }
    
    /* å»ºè®®å…ƒä¿¡æ¯ */
    .suggestion-meta { font-size:12px; color:#ad1457; background:#fce4ec; padding:4px 8px; border-radius:12px; }
    
    /* å»ºè®®å†…å®¹ */
    .suggestion-content { color:#5d4037; line-height:1.6; font-size:14px; padding:8px 0; word-break:break-word; }
    
    /* ç©ºçŠ¶æ€ */
    .empty { padding:40px 20px; text-align:center; color:#c2185b; font-size:16px; background:#fff8fa; border:2px dashed #f8bbd0; border-radius:16px; }
    .empty::before { content:"ğŸŒ¸"; font-size:24px; display:block; margin-bottom:8px; }
    
    /* å¢å¼ºå‹é˜²åˆ·æ ·å¼ */
    #captcha-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }
    
    #captcha {
      width: 200px;
      height: 60px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(233, 30, 99, 0.1);
      background-color: #fff;
    }
    
    #captcha:hover {
      box-shadow: 0 6px 12px rgba(233, 30, 99, 0.2);
    }
    
    #refresh-captcha {
      background-color: #880e4f;
      color: white;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    #refresh-captcha:hover {
      background-color: #ad1457;
    }
    
    #anti-spam-tip {
      margin-top: 10px;
      color: #dc3545;
      font-size: 14px;
      display: none;
      padding: 10px;
      background-color: #fff5f5;
      border-radius: 8px;
      border-left: 4px solid #dc3545;
    }
    
    #submit-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ„è§ç®±</h1>
    <div class="card">
      <form id="form">
        <div class="flex">
          <div style="flex:1">
            <label>å§“å</label>
            <input id="name" type="text" />
          </div>
          <div style="flex:1">
            <label>å­¦å·</label>
            <input id="number" type="number" />
          </div>
        </div>

        <label style="margin-top:12px">åˆ†ç±»</label>
        <select id="category">
          <option value="general">ä¸€èˆ¬å»ºè®®</option>
          <option value="bug">é”™è¯¯ / Bug</option>
          <option value="feature">åŠŸèƒ½è¯·æ±‚</option>
        </select>

        <label style="margin-top:12px">å†…å®¹</label>
        <textarea id="message" maxlength="500"></textarea>

        <label style="margin-top:12px">
          <input id="anon" type="checkbox" /> åŒ¿åæäº¤
        </label>

        <div class="card" style="margin-top:20px; background:#16213e; border:2px solid #0f3460;">
          <strong style="color:#e94560; text-transform:uppercase; letter-spacing:0.5px;">é˜²åˆ·éªŒè¯</strong>
          <!-- CSRFä»¤ç‰Œ -->
          <input type="hidden" id="csrfToken" value="${csrfToken}">
          <!-- Honeypotå­—æ®µ -->
          <input type="text" id="honeypot" style="display:none;" placeholder="è¯·ä¸è¦å¡«å†™æ­¤å­—æ®µ">
          
          <!-- å¢å¼ºå‹éªŒè¯ç  -->
          <div id="captcha-container">
            <canvas id="captcha" width="200" height="60"></canvas>
            <button type="button" id="refresh-captcha" class="btn-ghost">åˆ·æ–°</button>
          </div>
          <input id="captchaAns" type="text" placeholder="è¯·è¾“å…¥éªŒè¯ç " style="margin-bottom:10px;" />
          <div id="anti-spam-tip"></div>
        </div>

        <button class="btn-primary" type="submit" id="submit-btn" style="margin-top:14px">æäº¤</button>
      </form>
    </div>

    <div class="card">
      <h3>å†å²è®°å½•</h3>
      <div id="list"></div>
    </div>
  </div>

<script>
// æ„è§åé¦ˆè¡¨å•æäº¤å¤„ç†

// APIåŸºç¡€URL
const API_BASE_URL = '/api/suggestion';

// -------- é˜²åˆ·æœºåˆ¶ï¼šå¢å¼ºå‹éªŒè¯ç  --------
let captchaText = '';
let lastSubmitTime = 0;
let submitAttempts = 0;
const MIN_SUBMIT_INTERVAL = 60000; // 60ç§’æäº¤é—´éš”
const MAX_ATTEMPTS = 3; // æœ€å¤§å°è¯•æ¬¡æ•°

// ç”Ÿæˆå¤æ‚å›¾å½¢éªŒè¯ç 
function generateCaptcha() {
  const canvas = document.getElementById('captcha');
  const ctx = canvas.getContext('2d');
  
  // ä½¿ç”¨å­—æ¯å’Œæ•°å­—ï¼Œæ’é™¤å®¹æ˜“æ··æ·†çš„å­—ç¬¦
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  captchaText = '';
  
  // ç”ŸæˆéšæœºèƒŒæ™¯è‰²
  const bgColor = getRandomColor(200, 255);
  ctx.fillStyle = bgColor;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // æ·»åŠ å™ªç‚¹
  for (let i = 0; i < 200; i++) {
    ctx.fillStyle = getRandomColor(100, 200);
    ctx.beginPath();
    ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 2, 0, Math.PI * 2);
    ctx.fill();
  }
  
  // æ·»åŠ å¹²æ‰°çº¿
  for (let i = 0; i < 5; i++) {
    ctx.strokeStyle = getRandomColor(100, 180);
    ctx.lineWidth = Math.random() * 2 + 1;
    ctx.beginPath();
    ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
    ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
    ctx.stroke();
  }
  
  // ç”Ÿæˆå¹¶ç»˜åˆ¶å­—ç¬¦
  const fontSize = 24 + Math.random() * 8;
  const fontFamilies = ['Arial', 'Verdana', 'Courier New', 'Georgia', 'Times New Roman'];
  
  for (let i = 0; i < 6; i++) {
    const char = chars.charAt(Math.floor(Math.random() * chars.length));
    captchaText += char;
    
    ctx.fillStyle = getRandomColor(50, 150);
    ctx.font = fontSize + 'px ' + fontFamilies[Math.floor(Math.random() * fontFamilies.length)];
    ctx.textBaseline = 'middle';
    
    // å­—ç¬¦æ—‹è½¬ã€ç¼©æ”¾ã€ä½ç§»
    const x = 30 + i * 28 + Math.random() * 10 - 5;
    const y = canvas.height / 2 + Math.random() * 10 - 5;
    const rotation = (Math.random() - 0.5) * 0.6; // æ—‹è½¬è§’åº¦
    const scale = 0.8 + Math.random() * 0.4; // ç¼©æ”¾æ¯”ä¾‹
    
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(rotation);
    ctx.scale(scale, scale);
    ctx.fillText(char, 0, 0);
    ctx.restore();
  }
  
  // æ·»åŠ æ³¢æµªå¹²æ‰°
  ctx.strokeStyle = getRandomColor(100, 180);
  ctx.lineWidth = Math.random() * 2;
  ctx.beginPath();
  for (let x = 0; x < canvas.width; x++) {
    const y = Math.sin(x / 20 + Math.random() * 2) * 10 + canvas.height / 2;
    if (x === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  }
  ctx.stroke();
}

// ç”Ÿæˆéšæœºé¢œè‰²
function getRandomColor(min, max) {
  const r = Math.floor(Math.random() * (max - min) + min);
  const g = Math.floor(Math.random() * (max - min) + min);
  const b = Math.floor(Math.random() * (max - min) + min);
  return `rgb(${r}, ${g}, ${b})`;
}

generateCaptcha();

// åˆ·æ–°éªŒè¯ç 
document.getElementById('refresh-captcha').addEventListener('click', generateCaptcha);

// ç‚¹å‡»éªŒè¯ç ä¹Ÿå¯åˆ·æ–°
document.getElementById('captcha').addEventListener('click', generateCaptcha);

// -------- è¡¨å•æäº¤ --------
document.getElementById('form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submit-btn');
  const antiSpamTip = document.getElementById('anti-spam-tip');
  
  // 1) æ£€æŸ¥èœœç½å­—æ®µï¼ˆé˜²æ­¢è‡ªåŠ¨æœºå™¨äººï¼‰
  const honeypot = document.getElementById('honeypot').value;
  if (honeypot.trim() !== '') {
    alert('é˜²åˆ·éªŒè¯å¤±è´¥');
    return;
  }
  
  // 2) æ£€æŸ¥æäº¤é—´éš”
  const now = Date.now();
  if (now - lastSubmitTime < MIN_SUBMIT_INTERVAL) {
    const remainingTime = Math.ceil((MIN_SUBMIT_INTERVAL - (now - lastSubmitTime)) / 1000);
    antiSpamTip.textContent = `æäº¤è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… ${remainingTime} ç§’åå†è¯•ã€‚`;
    antiSpamTip.style.display = 'block';
    return;
  }
  
  // 3) æ£€æŸ¥å°è¯•æ¬¡æ•°
  if (submitAttempts >= MAX_ATTEMPTS) {
    antiSpamTip.textContent = `å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯· ${Math.ceil(MIN_SUBMIT_INTERVAL / 1000)} ç§’åå†è¯•ã€‚`;
    antiSpamTip.style.display = 'block';
    submitBtn.disabled = true;
    setTimeout(() => {
      submitBtn.disabled = false;
      submitAttempts = 0;
      antiSpamTip.style.display = 'none';
    }, MIN_SUBMIT_INTERVAL);
    return;
  }
  
  // 4) éªŒè¯ç éªŒè¯
  const inputVal = document.getElementById('captchaAns').value.trim().toUpperCase();
  if (inputVal !== captchaText) {
    antiSpamTip.textContent = 'éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚';
    antiSpamTip.style.display = 'block';
    generateCaptcha();
    submitAttempts++;
    return;
  }
  
  // 5) å†…å®¹éªŒè¯
  const msg = document.getElementById('message').value.trim();
  if (msg.length < 5) {
    alert('è¯·è‡³å°‘è¾“å…¥ 5 ä¸ªå­—ã€‚');
    return;
  }
  
  // 6) å‡†å¤‡æäº¤æ•°æ®
  const name = document.getElementById('name').value.trim();
  const category = document.getElementById('category').value;
  const anon = document.getElementById('anon').checked;
  
  const suggestionData = {
    title: category, // ä½¿ç”¨åˆ†ç±»ä½œä¸ºæ ‡é¢˜
    context: msg,
    isAnonymous: anon,
    name: anon ? '' : name
  };

  console.log(suggestionData);
  
  // 7) ç¦ç”¨æäº¤æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
  submitBtn.disabled = true;
  submitBtn.textContent = 'æäº¤ä¸­...';
  antiSpamTip.style.display = 'none';
  
  try {
    // 8) å‘é€POSTè¯·æ±‚åˆ°åç«¯
    const response = await fetch(`${API_BASE_URL}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(suggestionData)
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.message || 'æäº¤å¤±è´¥');
    }
    
    alert('æäº¤æˆåŠŸï¼');
    document.getElementById('form').reset();
    generateCaptcha();
    // é‡ç½®é˜²åˆ·æœºåˆ¶
    lastSubmitTime = now;
    submitAttempts = 0;
    // åˆ·æ–°å†å²è®°å½•
    fetchSuggestions();
  } catch (error) {
    console.error('æäº¤å¤±è´¥:', error);
    alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    submitAttempts++;
  } finally {
    // æ¢å¤æäº¤æŒ‰é’®çŠ¶æ€
    submitBtn.disabled = false;
    submitBtn.textContent = 'æäº¤';
  }
});

// -------- è·å–å†å²è®°å½• --------
async function fetchSuggestions() {
  try {
    const response = await fetch(`${API_BASE_URL}/all`);
    if (!response.ok) {
      throw new Error('è·å–å†å²è®°å½•å¤±è´¥');
    }
    const result = await response.json();
    if (result.code === 200 && result.data) {
      renderSuggestions(result.data);
    } else {
      renderEmpty();
    }
  } catch (error) {
    console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
    renderEmpty();
  }
}

// -------- æ¸²æŸ“å†å²è®°å½• --------
function renderSuggestions(suggestions) {
  const listContainer = document.getElementById('list');
  listContainer.innerHTML = '';
  
  if (!suggestions || suggestions.length === 0) {
    renderEmpty();
    return;
  }
  
  // æŒ‰IDé™åºæ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
  suggestions.sort((a, b) => b.id - a.id);
  
  suggestions.forEach(suggestion => {
    const suggestionItem = document.createElement('div');
    suggestionItem.className = 'suggestion-item';
    
    // æ ‡é¢˜å’ŒåŒ¿åä¿¡æ¯
    const header = document.createElement('div');
    header.className = 'suggestion-header';
    
    const title = document.createElement('span');
    title.className = 'suggestion-title';
    title.textContent = getTitleText(suggestion.title);
    
    const meta = document.createElement('span');
    meta.className = 'suggestion-meta';
    meta.textContent = suggestion.isAnonymous ? 'åŒ¿å' : (suggestion.name || 'æœªçŸ¥');
    
    header.appendChild(title);
    header.appendChild(meta);
    
    // å†…å®¹
    const content = document.createElement('div');
    content.className = 'suggestion-content';
    content.textContent = suggestion.context;
    
    suggestionItem.appendChild(header);
    suggestionItem.appendChild(content);
    listContainer.appendChild(suggestionItem);
  });
}

// -------- æ¸²æŸ“ç©ºçŠ¶æ€ --------
function renderEmpty() {
  const listContainer = document.getElementById('list');
  listContainer.innerHTML = '<div class="empty">æš‚æ— å†å²è®°å½•</div>';
}

// -------- è·å–æ ‡é¢˜æ–‡æœ¬ --------
function getTitleText(title) {
  const titleMap = {
    'general': 'âš”ï¸ ä¸€èˆ¬å»ºè®®',
    'bug': 'ğŸ› BUGä¸¾æŠ¥',
    'feature': 'ğŸŒŸ æ–°å†…å®¹è¯·æ±‚'
  };
  return titleMap[title] || title;
}

// -------- é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½• --------
document.addEventListener('DOMContentLoaded', fetchSuggestions);
</script>
</body>
</html>